<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.greengram3.dm.DmMapper">
    <insert id="insDm" useGeneratedKeys="true" keyProperty="idm">
        insert into t_dm
        set last_msg = null
    </insert>

    <!-- t_dm_user -->
    <insert id="insDmUser">
        insert into t_dm_user
        set idm = #{idm},
        iuser = #{iuser}
    </insert>

    <select id="selDmMsgAll">
        select a.iuser as writerIuser, a.pic as writerPic,
        b.seq, b.msg, b.created_at as createdAt
        from t_user a
        join t_dm_msg b
        on a.iuser = b.iuser
        where b.idm = #{idm}
        order by b.seq desc
        limit #{startIdx}, #{rowCount}
    </select>

    <select id="selDmAll">
        select a.idm, a.last_msg as lastMsg, a.last_msg_at as lastMsgAt,
        d.iuser as otherPersonIuser, d.nm as otherPersonNm, d.pic as otherPersonPic
        from t_dm a
        join t_dm_user b
        on a.idm = b.idm
        join t_dm_user c
        on b.idm = c.idm
        join t_user d
        on c.iuser = d.iuser
        where b.iuser = #{loginedIuser}
        and c.iuser != #{loginedIuser}
        order by a.last_msg_at desc
        limit #{startIdx}, #{rowCount}
    </select>

    <insert id="insDmMsg">
        <selectKey resultType="int" keyProperty="seq" order="BEFORE">
            SELECT IFNULL(MAX(seq), 0) + 1
            FROM t_dm_msg
            WHERE idm = #{idm}
        </selectKey>
        insert into t_dm_msg
        set idm = #{idm},
        seq = #{seq},
        iuser = #{loginedIuser},
        msg = #{msg}
    </insert>

    <delete id="delDmMsg">
        delete from t_dm_msg
        where idm = #{idm}
        and seq = #{seq}
        and iuser = #{iuser}
    </delete>

    <insert id="insSelDm">
        insert into t_dm_user
        (idm, iuser)
        values
        (#{idm}, #{loginedIuser}),
        (#{idm}, #{otherPersonIuser})
    </insert>

    <select id="selDmByIns">
        SELECT A.idm
        FROM t_dm_user A
        JOIN t_dm_user B
        ON A.idm = B.idm
        WHERE A.iuser = #{loginedIuser}
        AND B.iuser = #{otherPersonIuser}
    </select>

</mapper>
